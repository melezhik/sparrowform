#!/usr/bin/env perl6

use v6;
use Data::Dump;

my $tf-show = run 'terraform', 'show', :out;

my $resource-id;
my %resources = Hash.new;

for $tf-show.out.lines -> $line {
  if $line ~~ /^ (\S+) ':' $/ { # set new resource
    $resource-id = "$0";
    %resources{$resource-id} = Hash.new;
    next;
  }
    
   if $line ~~ /^ \s+ (\S+) \s+ '=' \s+ (.*) $/ { # read resource attrubutes
    #say $0;
    %resources{$resource-id}{"$0"} = "$1";
    next;
   }
}


$tf-show.out.close();

say Dump(%resources) if %*ENV<SPF_DEBUG>;

for %resources.keys -> $r {
  next unless ("$r"~".sparrowfile").IO ~~ :e;
  my $public-ip = %resources{$r}<public_ip>;
  say "provision $r <$public-ip> ...";
  my $cmd = "sparrowdo --sparrowfile=" ~ "$r.sparrowfile --host=" ~ $public-ip ~ " " ~ ( join " ", @*ARGS );
  say "run $cmd" if %*ENV<SPF_DEBUG>;
  shell $cmd;
}

